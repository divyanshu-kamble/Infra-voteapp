pipeline {
    agent {
        kubernetes {
            defaultContainer 'jnlp'
            yaml '''
    apiVersion: v1
    kind: Pod
    metadata:
        namespace: jenkins-testing
        name: sample-kube
    spec:
      containers:
      - name: dind
        image: docker:24-dind
        volumeMounts:
        - mountPath: /var/build-data/
          name: jenkins-bld
        securityContext:
            privileged: true
      volumes:
      - name: jenkins-bld
        persistentVolumeClaim:
          claimName: jenkins-build
'''
        }
}
        stages {
            stage('Terraform init') {
                steps {
                    withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY', credentialsId: 'aws')])
                    {
                    container('dind') {
                        sh '''
                        pwd
                        cd Terraform/jenkins-agent/
                        docker run -v ${PWD}:/Terraform/jenkins-agent/ -w /Terraform/jenkins-agent/ hashicorp/terraform:latest init
                        '''
                    }
                }
            }
        }
            stage('Terraform Plan') {
                steps {
                    withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY', credentialsId: 'aws')])
                    {
                    container('dind') {
                        sh '''
                        cd Terraform/jenkins-agent/
                        docker run -v ${PWD}:/Terraform/jenkins-agent/ -w /Terraform/jenkins-agent/ hashicorp/terraform:latest plan
                        '''
                    }
                }
            }
            }
            // stage('Terraform Apply') {
            //     steps {
            //         container('dind') {
            //             sh '''
            //             cd Terraform/jenkins-agent/
            //             docker run -d hashicorp/terraform:latest terraform apply
            //             '''
            //             dir('Terraform/jenkins-agent/'){
            //                 script{
            //                     env.INSTANCE_IP = sh(script: 'terraform output -raw instance_public_ip', returnStdout: true).trim()
            //                 }
            //             sh "echo ${INSTANCE_IP}"
            //             }
            //         }
            //     }
            // }
            // stage('output IP Address'){
            //     steps{
            //         sh 'echo ${INSTANCE_IP}'
            //     }
            // }
        }
    }