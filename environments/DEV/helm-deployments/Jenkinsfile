pipeline {
  agent { label 'Deploy'}
  environment {
        NAMESPACE = 'dev'
    }
  stages {
    stage('Checking namespace') {
      steps {
        sh '''
          alias k=kubectl 
          value=$(k get namespace | grep ${NAMESPACE}-voting-app)
          if [ -z "$value" ]; then
          k create namespace ${NAMESPACE}-voting-app
          else
          echo "namespace ${NAMESPACE}-voting-app exists"
          fi
        '''
      }
        }
    stage('Helm Deployment') {
      steps {
        sh '''
           helm upgrade --install voting-app ${WORKSPACE}/environments/DEV/helm-deployments/voting-application/ --atomic --values ${WORKSPACE}/environments/DEV/helm-deployments/voting-application/values.yaml --set deploy.vote_app.image.imageTag=latest --set deploy.result_app.image.imageTag=latest --namespace ${NAMESPACE}-voting-app
        '''
      }
    }
  }
}